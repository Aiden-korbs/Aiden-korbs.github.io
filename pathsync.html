<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PathSync Analyzer - Aiden Corbin</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Dark Theme Dot Background */
        .bg-dots-dark {
            background-image: radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* Floaty Animations */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }
        @keyframes float-delayed {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }
        .animate-float { animation: float 6s ease-in-out infinite; }
        .animate-float-delayed { animation: float-delayed 7s ease-in-out 3s infinite; }

        /* Nav Links */
        .nav-link { position: relative; }
        .nav-link::after {
            content: ''; position: absolute; bottom: -4px; left: 0;
            height: 2px; width: 0; background-color: #ef4444; 
            transition: width 0.3s ease; border-radius: 2px;
        }
        .nav-link:hover::after, .nav-link-active::after { width: 100%; }
        
        /* Glassmorphism Cards */
        .premium-glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* Forms */
        .dark-input {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #f8fafc;
            transition: all 0.2s;
        }
        .dark-input:focus {
            border-color: #ef4444;
            outline: none;
            box-shadow: 0 0 0 1px #ef4444;
        }
        
        /* Forces native date picker popup to be dark mode on supported browsers */
        input[type="date"] {
            color-scheme: dark;
        }

        .spinner {
            border-top-color: #ef4444; 
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-950 text-slate-400 flex flex-col min-h-screen relative overflow-x-hidden">

    <!-- Ambient Glowing Orbs -->
    <div class="fixed top-[10%] left-[-10%] w-[40%] h-[40%] rounded-full bg-red-600/10 blur-[120px] pointer-events-none animate-float z-0"></div>
    <div class="fixed bottom-[10%] right-[-10%] w-[30%] h-[30%] rounded-full bg-orange-500/10 blur-[100px] pointer-events-none animate-float-delayed z-0"></div>
    <div class="fixed inset-0 bg-dots-dark z-0 opacity-40"></div>

    <!-- Floating Pill Navbar -->
    <header class="fixed top-6 inset-x-0 z-50 flex justify-center px-4">
        <nav class="w-full max-w-4xl bg-slate-900/60 backdrop-blur-xl border border-white/10 shadow-2xl shadow-black/50 rounded-full flex justify-between items-center px-6 py-3 transition-all">
            <a href="index.html" class="text-xl font-extrabold text-white tracking-tight drop-shadow-md">Aiden Corbin</a>
            <div class="flex items-center space-x-6 md:space-x-8 text-xs md:text-sm font-semibold uppercase tracking-wider text-slate-300">
                <a href="index.html" class="nav-link nav-link-active text-white">Projects</a>
                <a href="notes.html" class="nav-link hover:text-white transition-colors">Notes</a>
                <a href="about.html" class="nav-link hover:text-white transition-colors">About</a>
                <a href="https://github.com/Aiden-korbs" target="_blank" class="text-slate-400 hover:text-white transition-colors ml-2">
                    <svg class="w-5 h-5 drop-shadow-md" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.168 6.839 9.492.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.031-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.378.203 2.398.1 2.651.64.7 1.03 1.595 1.03 2.688 0 3.848-2.338 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.001 10.001 0 0022 12c0-5.523-4.477-10-10-10z" clip-rule="evenodd" /></svg>
                </a>
            </div>
        </nav>
    </header>

    <main class="relative z-10 max-w-7xl mx-auto px-6 pt-36 pb-24 min-h-screen flex-grow">
        
        <div class="mb-12">
            <a href="index.html#projects" class="inline-flex items-center text-sm font-semibold text-slate-500 hover:text-white transition-colors mb-6">&larr; Back to Projects</a>
        </div>

        <div class="lg:grid lg:grid-cols-3 lg:gap-12">
            
            <!-- Left Side: App Controls & Results -->
            <div class="lg:col-span-2 space-y-8">
                <div>
                    <h1 class="text-4xl md:text-5xl font-extrabold text-white tracking-tight mb-3">PathSync Analyzer</h1>
                    <p class="text-lg text-slate-400">Securely analyze Google Timeline files locally to find geographic proximity events between multiple people.</p>
                </div>

                <!-- Main Control Panel -->
                <div class="premium-glass-card rounded-3xl p-8 space-y-10">
                    
                    <!-- File Upload Section -->
                    <div>
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-8 h-8 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center font-bold border border-red-500/20">1</div>
                            <h2 class="text-xl font-bold text-white">Upload Timeline Files</h2>
                        </div>
                        <div id="file-inputs" class="space-y-4"></div>
                        <button id="add-file-btn" class="mt-4 text-sm font-semibold text-red-400 hover:text-red-300 transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                            Add Another File
                        </button>
                    </div>
                    
                    <hr class="border-white/10">

                    <!-- Filters Section -->
                    <div>
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-8 h-8 rounded-full bg-orange-500/20 text-orange-400 flex items-center justify-center font-bold border border-orange-500/20">2</div>
                            <h2 class="text-xl font-bold text-white">Set Filters & Thresholds</h2>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div>
                                <label for="start-date" class="block text-sm font-semibold text-slate-300 mb-2">Start Date</label>
                                <input type="date" id="start-date" class="dark-input block w-full rounded-xl sm:text-sm p-3">
                            </div>
                            <div>
                                <label for="end-date" class="block text-sm font-semibold text-slate-300 mb-2">End Date</label>
                                <input type="date" id="end-date" class="dark-input block w-full rounded-xl sm:text-sm p-3">
                            </div>
                            <div>
                                <label for="distance" class="block text-sm font-semibold text-slate-300 mb-2">Distance Threshold (meters)</label>
                                <input type="number" id="distance" value="100" class="dark-input block w-full rounded-xl sm:text-sm p-3">
                            </div>
                            <div>
                                <label for="time" class="block text-sm font-semibold text-slate-300 mb-2">Time Threshold (minutes)</label>
                                <input type="number" id="time" value="2" class="dark-input block w-full rounded-xl sm:text-sm p-3">
                            </div>
                        </div>
                    </div>

                </div>
                
                <!-- Action Button -->
                <div class="pt-4">
                    <button id="run-analysis" class="w-full bg-gradient-to-r from-red-600 to-red-500 text-white font-bold py-4 px-8 rounded-2xl hover:from-red-500 hover:to-orange-500 transition-all shadow-[0_0_20px_rgba(239,68,68,0.2)] hover:shadow-[0_0_30px_rgba(239,68,68,0.4)] hover:-translate-y-1 disabled:opacity-50 disabled:pointer-events-none disabled:transform-none">
                        Run Proximity Analysis
                    </button>
                </div>

                <!-- Results Section -->
                <div id="results-container" class="space-y-6 pt-8 hidden">
                    <h2 class="text-3xl font-extrabold text-white tracking-tight">Analysis Results</h2>
                    
                    <div id="status" class="text-center font-mono text-sm text-slate-300 p-4 bg-slate-900/50 rounded-xl border border-white/10 shadow-inner"></div>
                    <p id="summary" class="text-center font-medium text-lg text-white"></p>
                    
                    <div id="closest-match-card" class="premium-glass-card border border-emerald-500/30 rounded-3xl p-8 space-y-6 hidden">
                        <div class="flex items-center gap-3 border-b border-white/10 pb-4">
                            <span class="relative flex h-3 w-3">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                              <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
                            </span>
                            <h3 class="text-2xl font-bold text-white">Closest Match Found</h3>
                        </div>
                        <div id="closest-match-details" class="space-y-4 text-sm text-slate-300"></div>
                    </div>
                </div>
            </div>

            <!-- Right Side: Sticky Instructions -->
            <div class="lg:col-span-1 mt-12 lg:mt-0">
                <div class="sticky top-32">
                    <div class="premium-glass-card p-8 rounded-3xl">
                        <h3 class="text-xl font-bold text-white flex items-center gap-3 mb-6 pb-4 border-b border-white/10">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            How to Get Your Data
                        </h3>
                        <div class="text-slate-400 text-sm space-y-8">
                            <div>
                                <h4 class="font-semibold text-white mb-3 text-base">Method 1: Google Takeout (Desktop)</h4>
                                <ol class="list-decimal list-inside space-y-2 leading-relaxed">
                                    <li>Visit the <a href="https://takeout.google.com/" target="_blank" class="text-red-400 hover:text-red-300 hover:underline transition-colors font-medium">Google Takeout</a> website.</li>
                                    <li>Click "Deselect all", then scroll down and select "Location History".</li>
                                    <li>Ensure the format is JSON, then click "Create export".</li>
                                </ol>
                            </div>
                            <div>
                                <h4 class="font-semibold text-white mb-3 text-base">Method 2: Google Maps (Mobile)</h4>
                                <ol class="list-decimal list-inside space-y-2 leading-relaxed">
                                    <li>Open the Google Maps app and tap your profile picture.</li>
                                    <li>Go to "Your timeline", then tap the (...) menu and select "Settings and privacy".</li>
                                    <li>Scroll to "Location settings" and tap "Download a copy of your data".</li>
                                </ol>
                            </div>
                            <div class="p-4 bg-slate-900/50 rounded-xl border border-white/5 text-xs font-mono mt-8 text-slate-500">
                                > PRIVACY NOTE: All files are processed locally in your browser. No location data is uploaded to any server.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <footer class="py-10 text-center text-sm text-slate-500 border-t border-white/5 bg-slate-950/50 backdrop-blur-md relative z-10 w-full">
      © 2026 Aiden Corbin — Built with TailwindCSS
    </footer>

    <!-- PathSync Application Logic (Unchanged functionally, styling updated) -->
    <script>
        const fileUploadContainer = document.getElementById('file-inputs');
        const addFileBtn = document.getElementById('add-file-btn');
        const runBtn = document.getElementById('run-analysis');
        const resultsContainer = document.getElementById('results-container');
        const statusEl = document.getElementById('status');
        const summaryEl = document.getElementById('summary');
        const closestMatchCard = document.getElementById('closest-match-card');
        const closestMatchDetails = document.getElementById('closest-match-details');
        let fileInputCounter = 0;

        function createFileInput() {
            fileInputCounter++;
            const wrapper = document.createElement('div');
            wrapper.className = 'flex flex-col sm:flex-row sm:items-center gap-3 bg-slate-900/40 p-2 rounded-xl border border-white/5';
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.id = `file-input-${fileInputCounter}`;
            input.className = 'hidden';
            
            const label = document.createElement('label');
            label.htmlFor = input.id;
            // Updated to Dark Theme styles
            label.className = 'cursor-pointer shrink-0 bg-white/5 hover:bg-white/10 border border-white/10 text-slate-200 text-sm font-semibold py-2.5 px-5 rounded-lg transition-all text-center';
            label.textContent = 'Choose JSON File';

            const fileNameSpan = document.createElement('span');
            fileNameSpan.className = 'text-slate-500 font-mono text-sm truncate px-2';
            fileNameSpan.textContent = 'No file selected...';

            input.addEventListener('change', () => {
                if (input.files.length > 0) {
                    fileNameSpan.textContent = input.files[0].name;
                    fileNameSpan.classList.remove('text-slate-500');
                    fileNameSpan.classList.add('text-emerald-400');
                } else {
                    fileNameSpan.textContent = 'No file selected...';
                    fileNameSpan.classList.remove('text-emerald-400');
                    fileNameSpan.classList.add('text-slate-500');
                }
            });
            wrapper.append(input, label, fileNameSpan);
            fileUploadContainer.appendChild(wrapper);
        }
        
        createFileInput();
        createFileInput();
        addFileBtn.addEventListener('click', createFileInput);

        runBtn.addEventListener('click', async () => {
            runBtn.disabled = true;
            runBtn.innerHTML = `<div class="spinner w-5 h-5 border-4 rounded-full inline-block mr-2 align-middle"></div> Analyzing Data...`;
            resultsContainer.classList.remove('hidden');
            statusEl.textContent = '> Starting analysis sequence...';
            summaryEl.textContent = '';
            closestMatchCard.classList.add('hidden');
            
            const files = Array.from(document.querySelectorAll('input[type="file"]'))
                .filter(input => input.files.length > 0).map(input => input.files[0]);

            if (files.length < 2) {
                statusEl.innerHTML = '<span class="text-red-400">> Error: Please select at least two JSON files to compare.</span>';
                runBtn.disabled = false;
                runBtn.textContent = 'Run Proximity Analysis';
                return;
            }
            
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            let processedData = {};
            for (const file of files) {
                statusEl.textContent = `> Parsing ${file.name}...`;
                try {
                    const jsonData = JSON.parse(await file.text());
                    const events = parseTimelineData(jsonData, startDate, endDate);
                    if (events.length > 0) {
                        processedData[file.name] = events;
                    } else {
                        statusEl.textContent += ` (Warning: No valid events found in date range).`;
                    }
                } catch (error) {
                    statusEl.innerHTML = `<span class="text-red-400">> Error processing ${file.name}: ${error.message}</span>`;
                    runBtn.disabled = false;
                    runBtn.textContent = 'Run Proximity Analysis';
                    return;
                }
            }
            
            statusEl.textContent = '> Comparing coordinates and timestamps...';
            const fileKeys = Object.keys(processedData);
            let totalMatches = 0;
            let overallClosestMatch = null;
            
            for (let i = 0; i < fileKeys.length; i++) {
                for (let j = i + 1; j < fileKeys.length; j++) {
                    const [file1, file2] = [fileKeys[i], fileKeys[j]];
                    const [data1, data2] = [processedData[file1], processedData[file2]];
                    const distanceKm = parseFloat(document.getElementById('distance').value) / 1000;
                    const timeMins = parseInt(document.getElementById('time').value);
                    const matches = compareTimelines(data1, data2, timeMins, distanceKm);
                    
                    if (matches.length > 0) {
                        totalMatches += matches.length;
                        const closest = findClosestMatch(matches);
                        if (!overallClosestMatch || closest.distance_km < overallClosestMatch.distance_km) {
                            overallClosestMatch = closest;
                            overallClosestMatch.files = [file1, file2];
                        }
                    }
                }
            }

            if (totalMatches > 0) {
                summaryEl.innerHTML = `Analysis complete. Found <span class="text-emerald-400 font-bold">${totalMatches}</span> matches.`;
            } else {
                summaryEl.textContent = `Analysis complete. Found 0 matches.`;
            }

            if (overallClosestMatch) {
                statusEl.textContent = '> Interfacing with Nominatim API for location data...';
                const locationName = await getLocationName(overallClosestMatch.event1.latitude, overallClosestMatch.event1.longitude);
                displayClosestMatch(overallClosestMatch, locationName);
            } else {
                statusEl.textContent = '> Sequence complete. No proximity overlaps found within defined thresholds.';
            }

            runBtn.disabled = false;
            runBtn.textContent = 'Run Proximity Analysis';
        });

        function displayClosestMatch(match, locationName) {
            closestMatchCard.classList.remove('hidden');
            const [file1, file2] = match.files;
            const { event1, event2, distance_km, time_difference } = match; 
            const event1UTC = moment.utc(event1.timestamp).format('YYYY-MM-DD HH:mm:ss');
            const event2UTC = moment.utc(event2.timestamp).format('YYYY-MM-DD HH:mm:ss');

            // Updated colors for dark mode visibility
            closestMatchDetails.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-slate-900/50 p-4 rounded-xl border border-white/5 mb-6">
                    <div>
                        <span class="block text-slate-500 text-xs font-bold uppercase mb-1">Files Compared</span>
                        <span class="font-mono text-white text-sm break-all">${file1}<br>${file2}</span>
                    </div>
                    <div>
                        <span class="block text-slate-500 text-xs font-bold uppercase mb-1">Metrics</span>
                        <span class="text-white">Distance: <strong class="text-emerald-400">${(distance_km * 1000).toFixed(2)}m</strong></span><br>
                        <span class="text-white">Time Diff: <strong>${time_difference.toFixed(2)}s</strong></span>
                    </div>
                    <div class="md:col-span-2 mt-2">
                        <span class="block text-slate-500 text-xs font-bold uppercase mb-1">Approx. Location</span>
                        <span class="text-white font-medium">${locationName}</span>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="p-4 rounded-xl border border-amber-500/20 bg-amber-500/5">
                        <p class="font-bold text-amber-400 mb-2 border-b border-amber-500/20 pb-2 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                            Subject 1
                        </p>
                        <p class="font-mono text-xs mb-1"><span class="text-slate-500">File:</span> ${file1}</p>
                        <p class="font-mono text-xs mb-1"><span class="text-slate-500">Coordinates:</span> ${event1.latitude}, ${event1.longitude}</p>
                        <p class="font-mono text-xs"><span class="text-slate-500">Timestamp (UTC):</span> ${event1UTC}</p>
                    </div>

                    <div class="p-4 rounded-xl border border-rose-500/20 bg-rose-500/5">
                        <p class="font-bold text-rose-400 mb-2 border-b border-rose-500/20 pb-2 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                            Subject 2
                        </p>
                        <p class="font-mono text-xs mb-1"><span class="text-slate-500">File:</span> ${file2}</p>
                        <p class="font-mono text-xs mb-1"><span class="text-slate-500">Coordinates:</span> ${event2.latitude}, ${event2.longitude}</p>
                        <p class="font-mono text-xs"><span class="text-slate-500">Timestamp (UTC):</span> ${event2UTC}</p>
                    </div>
                </div>`;
            statusEl.textContent = '> Closest match details rendered below.';
        }
        
        function parseTimelineData(jsonData, startDateStr, endDateStr) {
            let events = [];
            const startDate = startDateStr ? new Date(startDateStr + 'T00:00:00Z').getTime() : null;
            const endDate = endDateStr ? new Date(endDateStr + 'T23:59:59Z').getTime() : null;

            const eventInRange = (timestamp) => {
                if (startDate && timestamp < startDate) return false;
                if (endDate && timestamp > endDate) return false;
                return true;
            };

            if (jsonData.semanticSegments) {
                jsonData.semanticSegments.forEach(segment => {
                    const processPoint = (time, locationString) => {
                        const timestamp = new Date(time).getTime();
                        if (eventInRange(timestamp) && typeof locationString === 'string') {
                            const coords = locationString.match(/[-+]?\d+\.\d+/g);
                            if (coords && coords.length === 2) events.push({timestamp, latitude: parseFloat(coords[0]), longitude: parseFloat(coords[1])});
                        }
                    };

                    if (segment.timelinePath) {
                        segment.timelinePath.forEach(point => processPoint(point.time, point.point));
                    } else if (segment.visit) {
                        processPoint(segment.startTime, segment.visit?.topCandidate?.placeLocation);
                    }
                });
            }
            else if (Array.isArray(jsonData)) {
                jsonData.forEach(item => {
                    const timestamp = new Date(item.startTime).getTime();
                    if (eventInRange(timestamp)) { 
                        const locStr = item.visit?.topCandidate?.placeLocation; 
                        if (locStr && typeof locStr === 'string') {
                            const coords = locStr.match(/[-+]?\d+\.\d+/g);
                            if (coords && coords.length === 2) events.push({timestamp, latitude: parseFloat(coords[0]), longitude: parseFloat(coords[1])});
                        }
                    }
                });
            }
            else if (jsonData.locations) {
                jsonData.locations.forEach(loc => {
                    const timestamp = new Date(loc.timestamp).getTime();
                    if (eventInRange(timestamp) && loc.latitudeE7 && loc.longitudeE7) {
                        events.push({timestamp, latitude: loc.latitudeE7 / 1e7, longitude: loc.longitudeE7 / 1e7});
                    }
                });
            }
            return events.sort((a, b) => a.timestamp - b.timestamp);
        }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; const toRad = x => x * Math.PI / 180;
            const dLat = toRad(lat2 - lat1); const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2)**2;
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
        }

        function compareTimelines(data1, data2, timeMins, distanceKm) {
            const matches = []; const timeMs = timeMins * 60 * 1000;
            let i = 0, j = 0;
            while (i < data1.length && j < data2.length) {
                const timeDiff = data1[i].timestamp - data2[j].timestamp;
                if (timeDiff > timeMs) { j++; continue; }
                if (timeDiff < -timeMs) { i++; continue; }
                let k = j;
                while (k < data2.length) {
                    const subTimeDiff = Math.abs(data1[i].timestamp - data2[k].timestamp);
                    if (subTimeDiff > timeMs) break;
                    const distance = haversineDistance(data1[i].latitude, data1[i].longitude, data2[k].latitude, data2[k].longitude);
                    if (distance <= distanceKm) matches.push({event1: data1[i], event2: data2[k], time_difference: subTimeDiff / 1000, distance_km: distance});
                    k++;
                }
                i++;
            }
            return matches;
        }

        function findClosestMatch(matches) {
            return !matches || matches.length === 0 ? null : matches.reduce((a, b) => b.distance_km < a.distance_km ? b : a);
        }
        
        async function getLocationName(lat, lon) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                if (!response.ok) throw new Error(`API failed: ${response.status}`);
                const data = await response.json();
                return data.display_name || "Unknown Location";
            } catch (error) {
                console.error("Geocoding error:", error);
                return "Could not fetch location name.";
            }
        }
    </script>
</body>
</html>