<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aiden Corbin - Notes Viewer</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'] }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        .bg-dots-dark {
          background-image: radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px);
          background-size: 24px 24px;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }
        .animate-float { animation: float 6s ease-in-out infinite; }

        .nav-link { position: relative; }
        .nav-link::after { content: ''; position: absolute; bottom: -4px; left: 0; height: 2px; width: 0; background-color: #ef4444; transition: width 0.3s ease; border-radius: 2px; }
        .nav-link:hover::after, .nav-link-active::after { width: 100%; }
        
        .premium-glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .premium-glass-card:hover {
            transform: translateY(-6px);
            background: rgba(255, 255, 255, 0.06);
            box-shadow: 0 25px 35px -5px rgba(0, 0, 0, 0.5), 0 0 20px -5px rgba(239, 68, 68, 0.2);
        }

        .spinner { border-top-color: #ef4444; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Dark Mode Markdown styles */
        #note-viewer-content h1, #note-viewer-content h2, #note-viewer-content h3 {
            color: #ffffff; border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 0.5rem; margin-top: 1.5rem; margin-bottom: 1rem;
        }
        #note-viewer-content p { margin-bottom: 1rem; color: #cbd5e1; line-height: 1.6; }
        #note-viewer-content a { color: #f87171; text-decoration: underline; }
        #note-viewer-content code { background-color: rgba(255,255,255,0.1); color: #f87171; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-size: 0.9em; }
        #note-viewer-content pre { background-color: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 1rem; border-radius: 0.75rem; overflow-x: auto; margin-bottom: 1rem; }
        #note-viewer-content pre code { background-color: transparent; color: #e2e8f0; }
        #note-viewer-content ul, #note-viewer-content ol { padding-left: 2rem; margin-bottom: 1rem; color: #cbd5e1; }
        #note-viewer-content li { margin-bottom: 0.5rem; }
        #note-viewer-content blockquote { border-left: 4px solid #f87171; padding-left: 1rem; margin: 1.5rem 0; color: #94a3b8; font-style: italic; }
        #note-viewer-content table { width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; border: 1px solid rgba(255,255,255,0.1); }
        #note-viewer-content th, #note-viewer-content td { padding: 0.75rem; border: 1px solid rgba(255,255,255,0.1); }
        #note-viewer-content th { background-color: rgba(255,255,255,0.05); text-align: left; font-weight: 600; color: #ffffff; }
        #note-viewer-content tr:nth-child(even) { background-color: rgba(255,255,255,0.02); }
        #note-viewer-content a.obsidian-link { color: #f87171; text-decoration: none; border-bottom: 1px dashed #f87171; opacity: 0.8; }
        #note-viewer-content a.obsidian-link:hover { color: #ef4444; border-bottom-style: solid; opacity: 1; }

        mjx-container { font-size: 1.05em; color: #e2e8f0; }
    </style>
</head>

<body class="bg-slate-950 text-slate-400 relative overflow-x-hidden min-h-screen flex flex-col">

    <!-- Ambient Glowing Orbs -->
    <div class="fixed top-[-10%] left-[-10%] w-[40%] h-[40%] rounded-full bg-red-600/10 blur-[120px] pointer-events-none animate-float z-0"></div>
    <div class="fixed top-[40%] right-[10%] w-[30%] h-[30%] rounded-full bg-orange-500/10 blur-[100px] pointer-events-none animate-float z-0"></div>
    <div class="fixed inset-0 bg-dots-dark z-0 opacity-40"></div>

    <!-- Floating Pill Navbar -->
    <header class="fixed top-6 inset-x-0 z-50 flex justify-center px-4">
      <nav class="w-full max-w-4xl bg-slate-900/60 backdrop-blur-xl border border-white/10 shadow-2xl shadow-black/50 rounded-full flex justify-between items-center px-6 py-3 transition-all">
        <a href="index.html" class="text-xl font-extrabold text-white tracking-tight drop-shadow-md">Aiden Corbin</a>
        <div class="flex items-center space-x-6 md:space-x-8 text-xs md:text-sm font-semibold uppercase tracking-wider text-slate-300">
          <a href="index.html" class="nav-link hover:text-white transition-colors">Projects</a>
          <a href="notes.html" class="nav-link nav-link-active text-white">Notes</a>
          <a href="about.html" class="nav-link hover:text-white transition-colors">About</a>
          <a href="https://github.com/Aiden-korbs" target="_blank" class="text-slate-400 hover:text-white transition-colors ml-2">
              <svg class="w-5 h-5 drop-shadow-md" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.168 6.839 9.492.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.031-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.378.203 2.398.1 2.651.64.7 1.03 1.595 1.03 2.688 0 3.848-2.338 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.001 10.001 0 0022 12c0-5.523-4.477-10-10-10z" clip-rule="evenodd" /></svg>
          </a>
        </div>
      </nav>
    </header>

    <main class="relative z-10 max-w-6xl mx-auto px-6 pt-36 pb-24 flex-grow w-full">
        <div class="mb-12">
            <a href="notes.html" class="inline-flex items-center text-sm font-semibold text-slate-500 hover:text-white transition-colors mb-4">&larr; Back to Collections</a>
            <h1 id="repo-title" class="text-4xl font-extrabold text-white mb-4">Notes Viewer</h1>
            <p id="repo-description" class="text-slate-400">Specify a repository in the URL to view its notes.</p>
        </div>
        <div id="notes-grid" class="space-y-12"></div>
    </main>

    <footer class="py-10 text-center text-sm text-slate-500 border-t border-white/5 bg-slate-950/50 backdrop-blur-md relative z-10 w-full mt-auto">
      © 2026 Aiden Corbin — Built with TailwindCSS
    </footer>

    <!-- Dark Glassmorphism Modal -->
    <div id="note-viewer" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md z-[100] hidden items-center justify-center p-4 md:p-8">
        <div class="bg-slate-900 border border-white/10 rounded-3xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden relative">
            <!-- Modal ambient glow -->
            <div class="absolute top-0 right-0 w-64 h-64 bg-red-600/10 blur-[80px] rounded-full pointer-events-none"></div>
            
            <div class="flex justify-between items-center p-6 border-b border-white/10 relative z-10">
                <h2 id="note-viewer-title" class="text-xl font-bold text-white"></h2>
                <button id="close-viewer-btn" class="text-slate-500 hover:text-white transition-colors text-3xl leading-none">&times;</button>
            </div>
            <div class="p-8 overflow-y-auto relative z-10 custom-scrollbar">
                <div id="note-viewer-content"></div>
            </div>
            <div class="p-6 border-t border-white/10 bg-slate-900/50 text-right relative z-10">
                <a id="repo-link" href="#" target="_blank" class="text-sm font-semibold text-red-400 hover:text-red-300 transition-colors">View Source on GitHub &rarr;</a>
            </div>
        </div>
    </div>

    <script>
        const notesGrid = document.getElementById('notes-grid');
        const noteViewer = document.getElementById('note-viewer');
        const noteViewerTitle = document.getElementById('note-viewer-title');
        const noteViewerContent = document.getElementById('note-viewer-content');
        const closeViewerBtn = document.getElementById('close-viewer-btn');
        const repoLink = document.getElementById('repo-link');

        let allMdFiles = [];
        let currentOwner = '';
        let currentRepo = '';
        let defaultBranchName = 'main';

        const showdownConverter = new showdown.Converter({
            tables: true, tasklists: true, simplifiedAutoLink: true, 
            strikethrough: true, ghCompatibleHeaderId: true, literalMidWordUnderscores: true
        });

        showdown.extension('obsidianlinks', () => [{
            type: 'lang',
            regex: /\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/g,
            replace: (match, target, alias) => {
                const noteName = target.trim();
                const displayText = alias ? alias.trim() : noteName;
                return `<a href="#" class="obsidian-link" data-note-name="${noteName}">${displayText}</a>`;
            }
        }]);
        showdownConverter.addExtension('obsidianlinks');

        const urlParams = new URLSearchParams(window.location.search);
        currentOwner = urlParams.get('owner');
        let rawRepo = urlParams.get('repo');
        let targetFolder = '';

        if (rawRepo) {
            if (rawRepo.includes('/')) {
                const parts = rawRepo.split('/');
                currentRepo = parts[0];
                const treeIndex = parts.indexOf('tree');
                if (treeIndex !== -1 && parts.length > treeIndex + 2) {
                    targetFolder = parts.slice(treeIndex + 2).join('/');
                } else if (parts.length > 1 && parts[1] !== 'tree') {
                    targetFolder = parts.slice(1).join('/');
                }
            } else {
                currentRepo = rawRepo;
            }
            
            document.getElementById('repo-title').textContent = targetFolder ? `Notes: ${currentRepo} / ${targetFolder}` : `Notes: ${currentRepo}`;
            document.getElementById('repo-description').textContent = `Browsing Markdown notes in '${currentRepo}'.`;
        }

        async function getMdFilesFromRepo(owner, repoName, folderPath) {
            try {
                const branchResponse = await fetch(`https://api.github.com/repos/${owner}/${repoName}`);
                if (!branchResponse.ok) {
                    if (branchResponse.status === 404) throw new Error("Repository not found. It might be Private.");
                    if (branchResponse.status === 403) throw new Error("GitHub API rate limit exceeded.");
                    throw new Error(`Could not fetch repo info. Status: ${branchResponse.status}`);
                }
                const branchData = await branchResponse.json();
                defaultBranchName = branchData.default_branch;

                const treeResponse = await fetch(`https://api.github.com/repos/${owner}/${repoName}/git/trees/${defaultBranchName}?recursive=1`);
                if (!treeResponse.ok) throw new Error(`Could not fetch repo tree. Status: ${treeResponse.status}`);
                const treeData = await treeResponse.json();

                return treeData.tree
                    .filter(file => {
                        const pathLower = file.path.toLowerCase();
                        return pathLower.endsWith('.md') && !pathLower.endsWith('readme.md') && file.type === 'blob' && 
                               (folderPath ? file.path.startsWith(folderPath + '/') || file.path === folderPath : true);
                    })
                    .map(file => file.path);
            } catch (error) {
                console.error(`Failed to get files:`, error);
                throw error; 
            }
        }

        function createNoteCard(filePath, owner, repo) {
            const card = document.createElement('div');
            // Updated to Premium Glass Card styles
            card.className = 'cursor-pointer premium-glass-card group p-6 rounded-3xl flex flex-col h-full';
            const title = filePath.split('/').pop().replace('.md', '').replace(/[-_]/g, ' ');
            card.innerHTML = `
                <div class="flex-grow">
                    <h3 class="font-bold text-xl text-white group-hover:text-red-400 transition-colors capitalize mb-2">${title}</h3>
                </div>
                <div class="pt-4 border-t border-white/5 mt-4">
                    <p class="text-slate-500 font-mono text-xs truncate">> ${filePath}</p>
                </div>
            `;
            card.addEventListener('click', () => fetchAndShowFile(owner, repo, title, filePath));
            return card;
        }

        async function fetchAndShowFile(owner, repoName, title, filePath) {
            noteViewerTitle.textContent = title;
            noteViewerContent.innerHTML = '<div class="flex justify-center items-center h-48"><div class="spinner w-8 h-8 border-4 rounded-full"></div></div>';
            repoLink.href = `https://github.com/${owner}/${repoName}/blob/${defaultBranchName}/${filePath}`;
            noteViewer.classList.remove('hidden');
            noteViewer.classList.add('flex');

            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repoName}/contents/${filePath}`);
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                const binaryString = atob(data.content);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
                const markdownContent = new TextDecoder('utf-8').decode(bytes);

                noteViewerContent.innerHTML = showdownConverter.makeHtml(markdownContent);
                if (window.MathJax && window.MathJax.typesetPromise) window.MathJax.typesetPromise([noteViewerContent]);
            } catch (error) {
                noteViewerContent.innerHTML = `<p class="text-red-400 font-semibold mb-2">Could not load notes.</p><p class="text-slate-500 text-sm">${error.message}</p>`;
            }
        }

        function findAndOpenNote(noteName, displayTitle) {
            const normalize = str => str.toLowerCase().replace(/[-_ ]/g, '');
            const targetNormalized = normalize(noteName);
            
            let foundPath = null;
            for (const filePath of allMdFiles) {
                const fileName = filePath.split('/').pop().replace('.md', '');
                if (normalize(fileName) === targetNormalized) {
                    foundPath = filePath;
                    break;
                }
            }
            if (foundPath) fetchAndShowFile(currentOwner, currentRepo, displayTitle, foundPath);
            else alert(`Note not found: "${noteName}"`);
        }

        async function populateNotesPage() {
            if (!currentOwner || !currentRepo) {
                notesGrid.innerHTML = '<p class="text-red-400 text-center font-semibold">Error: Repository not specified.</p>';
                return;
            }

            notesGrid.innerHTML = '<div class="flex justify-center items-center h-48"><div class="spinner w-8 h-8 border-4 rounded-full"></div><p class="ml-4 text-slate-400 font-medium">Scanning repository...</p></div>';
            
            try {
                const mdFiles = await getMdFilesFromRepo(currentOwner, currentRepo, targetFolder);
                allMdFiles = mdFiles;
                
                if (mdFiles.length > 0) {
                    notesGrid.innerHTML = '';
                    
                    const groupedFiles = mdFiles.reduce((acc, filePath) => {
                        const parts = filePath.split('/');
                        let folder = 'root';
                        if (parts.length > 1) folder = parts.slice(0, -1).join('/');
                        if (!acc[folder]) acc[folder] = [];
                        acc[folder].push(filePath);
                        return acc;
                    }, {});

                    function naturalSort(a, b) {
                        if (a === 'root') return -1;
                        if (b === 'root') return 1;
                        const re = /(\d+)/g;
                        const partsA = a.split(re);
                        const partsB = b.split(re);
                        for (let i = 0; i < Math.min(partsA.length, partsB.length); i++) {
                            if (i % 2 === 1) {
                                const numA = parseInt(partsA[i], 10), numB = parseInt(partsB[i], 10);
                                if (numA !== numB) return numA - numB;
                            } else {
                                if (partsA[i] !== partsB[i]) return partsA[i].localeCompare(partsB[i]);
                            }
                        }
                        return partsA.length - partsB.length;
                    }

                    const sortedFolders = Object.keys(groupedFiles).sort(naturalSort);
                    let commonPrefix = '';
                    const nonRootFolders = sortedFolders.filter(f => f !== 'root');

                    if (nonRootFolders.length > 0) {
                        const paths = nonRootFolders.map(f => f.split('/'));
                        const minLength = Math.min(...paths.map(p => p.length));
                        let prefixComponents = [];
                        for (let i = 0; i < minLength; i++) {
                            if (paths.every(p => p[i] === paths[0][i])) prefixComponents.push(paths[0][i]);
                            else break;
                        }
                        if (prefixComponents.length > 0) {
                            const tempPrefix = prefixComponents.join('/') + '/';
                            if (nonRootFolders.every(f => f.startsWith(tempPrefix) || f === prefixComponents.join('/'))) {
                                 commonPrefix = tempPrefix;
                            }
                        }
                    }

                    sortedFolders.forEach(folder => {
                        const sectionContainer = document.createElement('div');
                        const folderTitle = document.createElement('h2');
                        // Styled folder headings
                        folderTitle.className = 'text-2xl font-bold text-white mb-6 border-b border-white/10 pb-3 capitalize drop-shadow-sm';
                        
                        let displayFolderName = folder;
                        if (folder === 'root') displayFolderName = 'General Notes';
                        else if (commonPrefix && folder.startsWith(commonPrefix)) {
                            displayFolderName = folder.substring(commonPrefix.length);
                            if (displayFolderName === '') displayFolderName = folder; 
                        }
                        folderTitle.textContent = displayFolderName.replace(/[-_]/g, ' ');

                        sectionContainer.appendChild(folderTitle);
                        const folderGrid = document.createElement('div');
                        folderGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
                        
                        groupedFiles[folder].forEach(filePath => folderGrid.appendChild(createNoteCard(filePath, currentOwner, currentRepo)));

                        sectionContainer.appendChild(folderGrid);
                        notesGrid.appendChild(sectionContainer);
                    });
                } else {
                    notesGrid.innerHTML = '<p class="text-slate-500 text-center bg-white/5 p-8 rounded-2xl border border-white/10">No Markdown files found.</p>';
                }
            } catch (error) {
                notesGrid.innerHTML = `<div class="bg-red-500/10 border border-red-500/20 p-6 rounded-2xl">
                    <p class="text-red-400 font-bold mb-1">Failed to load repository</p>
                    <p class="text-slate-400 text-sm">${error.message}</p>
                </div>`;
            }
        }

        closeViewerBtn.addEventListener('click', () => { noteViewer.classList.add('hidden'); noteViewer.classList.remove('flex'); });
        noteViewer.addEventListener('click', (e) => { if (e.target === noteViewer) { noteViewer.classList.add('hidden'); noteViewer.classList.remove('flex'); } });
        noteViewerContent.addEventListener('click', (e) => {
            const link = e.target.closest('a.obsidian-link');
            if (link) {
                e.preventDefault();
                findAndOpenNote(link.getAttribute('data-note-name'), link.innerText);
            }
        });
        
        populateNotesPage();
    </script>
</body>
</html>