<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aiden Corbin - Notes Viewer</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'] }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'Fira Code', monospace; }
        
        .bg-dots-dark {
          background-image: radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px);
          background-size: 24px 24px;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }
        .animate-float { animation: float 6s ease-in-out infinite; }

        .nav-link { position: relative; }
        .nav-link::after { content: ''; position: absolute; bottom: -4px; left: 0; height: 2px; width: 0; background-color: #ef4444; transition: width 0.3s ease; border-radius: 2px; }
        .nav-link:hover::after, .nav-link-active::after { width: 100%; }
        
        .premium-glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* Custom Scrollbars for the panes */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }

        .spinner { border-top-color: #ef4444; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Dark Mode Markdown styles */
        #note-viewer-content { color: #cbd5e1; font-size: 1.05rem; line-height: 1.7; }
        #note-viewer-content h1 { color: #ffffff; font-size: 2.25rem; font-weight: 800; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0.5rem; margin-top: 2rem; margin-bottom: 1.5rem; letter-spacing: -0.025em; }
        #note-viewer-content h2 { color: #f8fafc; font-size: 1.8rem; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 0.5rem; margin-top: 2.5rem; margin-bottom: 1.25rem; }
        #note-viewer-content h3 { color: #f1f5f9; font-size: 1.4rem; font-weight: 600; margin-top: 2rem; margin-bottom: 1rem; }
        #note-viewer-content p { margin-bottom: 1.25rem; }
        #note-viewer-content a { color: #f87171; text-decoration: underline; text-decoration-color: rgba(248,113,113,0.4); text-underline-offset: 4px; transition: all 0.2s; }
        #note-viewer-content a:hover { text-decoration-color: #f87171; }
        #note-viewer-content code { background-color: rgba(239,68,68,0.1); color: #fca5a5; padding: 0.2rem 0.4rem; border-radius: 0.375rem; font-family: 'Fira Code', monospace; font-size: 0.85em; }
        #note-viewer-content pre { background-color: #0f172a; border: 1px solid rgba(255,255,255,0.1); padding: 1.25rem; border-radius: 0.75rem; overflow-x: auto; margin-top: 1.5rem; margin-bottom: 1.5rem; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); }
        #note-viewer-content pre code { background-color: transparent; color: #e2e8f0; padding: 0; }
        #note-viewer-content ul, #note-viewer-content ol { padding-left: 1.5rem; margin-bottom: 1.5rem; }
        #note-viewer-content li { margin-bottom: 0.5rem; }
        #note-viewer-content li::marker { color: #64748b; }
        #note-viewer-content blockquote { border-left: 4px solid #ef4444; background: linear-gradient(to right, rgba(239,68,68,0.1), transparent); padding: 1rem 1.5rem; margin: 1.5rem 0; color: #94a3b8; font-style: italic; border-radius: 0 0.5rem 0.5rem 0; }
        #note-viewer-content table { width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 2rem; border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; overflow: hidden; }
        #note-viewer-content th, #note-viewer-content td { padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
        #note-viewer-content th { background-color: rgba(255,255,255,0.05); text-align: left; font-weight: 600; color: #ffffff; }
        #note-viewer-content tr:last-child td { border-bottom: none; }
        #note-viewer-content img { max-width: 100%; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.1); margin: 1.5rem 0; }
        
        #note-viewer-content a.obsidian-link { color: #fca5a5; text-decoration: none; border-bottom: 1px dashed #ef4444; opacity: 0.9; font-weight: 500; }
        #note-viewer-content a.obsidian-link:hover { color: #f87171; border-bottom-style: solid; opacity: 1; }

        mjx-container { font-size: 1.1em; color: #e2e8f0; }
        mjx-container[jax="CHTML"][display="true"] { margin: 2rem 0; overflow-x: auto; padding: 1rem 0; }
        
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>

<body class="bg-slate-950 text-slate-400 relative overflow-x-hidden h-screen flex flex-col">

    <!-- Ambient Glowing Orbs -->
    <div class="fixed top-[-10%] left-[-10%] w-[40%] h-[40%] rounded-full bg-red-600/10 blur-[120px] pointer-events-none animate-float z-0"></div>
    <div class="fixed bottom-[-10%] right-[-10%] w-[30%] h-[30%] rounded-full bg-orange-500/10 blur-[100px] pointer-events-none animate-float z-0"></div>
    <div class="fixed inset-0 bg-dots-dark z-0 opacity-40"></div>

    <!-- Floating Pill Navbar -->
    <header class="fixed top-6 inset-x-0 z-50 flex justify-center px-4">
      <nav class="w-full max-w-4xl bg-slate-900/80 backdrop-blur-xl border border-white/10 shadow-2xl shadow-black/50 rounded-full flex justify-between items-center px-6 py-3 transition-all">
        <a href="index.html" class="text-xl font-extrabold text-white tracking-tight drop-shadow-md">Aiden Corbin</a>
        <div class="flex items-center space-x-6 md:space-x-8 text-xs md:text-sm font-semibold uppercase tracking-wider text-slate-300">
          <a href="index.html" class="nav-link hover:text-white transition-colors">Projects</a>
          <a href="notes.html" class="nav-link nav-link-active text-white">Notes</a>
          <a href="about.html" class="nav-link hover:text-white transition-colors">About</a>
        </div>
      </nav>
    </header>

    <!-- Two-Pane Integrated Layout -->
    <main class="relative z-10 w-full max-w-[90rem] mx-auto px-4 md:px-6 pt-28 pb-6 flex-grow flex flex-col lg:flex-row gap-6 h-full overflow-hidden">
        
        <!-- Left Pane: Sidebar (File Tree) -->
        <aside class="w-full lg:w-80 flex-shrink-0 premium-glass-card rounded-3xl flex flex-col overflow-hidden h-[40vh] lg:h-full transition-all">
            <div class="p-6 border-b border-white/10 bg-white/[0.02]">
                <a href="notes.html" class="inline-flex items-center text-xs font-semibold text-slate-500 hover:text-white transition-colors mb-3">&larr; Back to Collections</a>
                <h1 id="repo-title" class="text-2xl font-extrabold text-white tracking-tight truncate">Loading Repo...</h1>
                <p id="repo-description" class="text-xs text-slate-500 mt-1 truncate">Fetching notes data</p>
            </div>
            
            <div class="p-4 overflow-y-auto custom-scrollbar flex-grow" id="sidebar-content">
                <div class="flex justify-center items-center h-20">
                    <div class="spinner w-6 h-6 border-2 rounded-full"></div>
                </div>
            </div>
        </aside>

        <!-- Right Pane: Main Reading Canvas -->
        <section class="flex-grow premium-glass-card rounded-3xl flex flex-col overflow-hidden h-[50vh] lg:h-full relative bg-slate-950/40">
            
            <!-- Reading Header -->
            <div class="p-6 md:px-10 border-b border-white/10 bg-white/[0.02] flex justify-between items-center z-10 sticky top-0 backdrop-blur-md">
                <div class="overflow-hidden">
                    <p id="current-folder" class="text-xs font-mono text-slate-500 mb-1 truncate"></p>
                    <h2 id="note-viewer-title" class="text-xl md:text-2xl font-bold text-white truncate">Select a Note</h2>
                </div>
                <a id="repo-link" href="#" target="_blank" class="hidden shrink-0 ml-4 px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-xs font-semibold text-slate-300 hover:text-white transition-colors items-center gap-2">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.168 6.839 9.492.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.031-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.378.203 2.398.1 2.651.64.7 1.03 1.595 1.03 2.688 0 3.848-2.338 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.001 10.001 0 0022 12c0-5.523-4.477-10-10-10z" clip-rule="evenodd" /></svg>
                    <span class="hidden sm:inline">Source</span>
                </a>
            </div>
            
            <!-- Markdown Content -->
            <div class="p-6 md:p-10 overflow-y-auto custom-scrollbar flex-grow scroll-smooth" id="scroll-container">
                <div class="max-w-4xl mx-auto w-full">
                    <div id="note-viewer-content" class="min-h-full">
                        <div class="h-full flex flex-col items-center justify-center text-slate-500 py-20 opacity-50">
                            <svg class="w-16 h-16 mb-4 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            <p>Select a document from the sidebar to start reading.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <script>
        const sidebarContent = document.getElementById('sidebar-content');
        const noteViewerTitle = document.getElementById('note-viewer-title');
        const noteViewerContent = document.getElementById('note-viewer-content');
        const currentFolderEl = document.getElementById('current-folder');
        const repoLink = document.getElementById('repo-link');
        const scrollContainer = document.getElementById('scroll-container');

        let allMdFiles = [];
        let currentOwner = '';
        let currentRepo = '';
        let defaultBranchName = 'main';

        // MathJax Protection Extension to prevent Showdown from destroying math formatting
        let mathBlocks = [];
        showdown.extension('mathjax', () => [
            {
                type: 'lang',
                regex: /\$\$([\s\S]+?)\$\$/g, 
                replace: (match) => {
                    mathBlocks.push(match);
                    return `%%MATH_BLOCK_${mathBlocks.length - 1}%%`;
                }
            },
            {
                type: 'lang',
                regex: /\\\[([\s\S]+?)\\\]/g, 
                replace: (match) => {
                    mathBlocks.push(match);
                    return `%%MATH_BLOCK_${mathBlocks.length - 1}%%`;
                }
            },
            {
                type: 'lang',
                regex: /\\\((.+?)\\\)/g, 
                replace: (match) => {
                    mathBlocks.push(match);
                    return `%%MATH_INLINE_${mathBlocks.length - 1}%%`;
                }
            },
            {
                type: 'lang',
                regex: /\$([^ \n][^\n]*?[^ \n])\$/g, 
                replace: (match) => {
                    mathBlocks.push(match);
                    return `%%MATH_INLINE_${mathBlocks.length - 1}%%`;
                }
            },
            {
                type: 'lang',
                regex: /\$([^ \n])\$/g, 
                replace: (match) => {
                    mathBlocks.push(match);
                    return `%%MATH_INLINE_${mathBlocks.length - 1}%%`;
                }
            },
            {
                type: 'output',
                regex: /%%MATH_(BLOCK|INLINE)_(\d+)%%/g, 
                replace: (match, type, index) => {
                    return mathBlocks[index];
                }
            }
        ]);

        showdown.extension('obsidianlinks', () => [{
            type: 'lang',
            regex: /\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/g,
            replace: (match, target, alias) => {
                const noteName = target.trim();
                const displayText = alias ? alias.trim() : noteName;
                return `<a href="#" class="obsidian-link" data-note-name="${noteName}">${displayText}</a>`;
            }
        }]);

        const showdownConverter = new showdown.Converter({
            tables: true, 
            tasklists: true, 
            simplifiedAutoLink: true, 
            strikethrough: true, 
            ghCompatibleHeaderId: true, 
            literalMidWordUnderscores: true,
            extensions: ['mathjax', 'obsidianlinks']
        });

        // Helper function to safely generate an ID from a file path containing Unicode characters
        function getSafeId(str) {
            return encodeURIComponent(str).replace(/[^a-zA-Z0-9]/g, '_');
        }

        const urlParams = new URLSearchParams(window.location.search);
        currentOwner = urlParams.get('owner');
        let rawRepo = urlParams.get('repo');
        let targetFolder = '';

        if (rawRepo) {
            if (rawRepo.includes('/')) {
                const parts = rawRepo.split('/');
                currentRepo = parts[0];
                const treeIndex = parts.indexOf('tree');
                if (treeIndex !== -1 && parts.length > treeIndex + 2) {
                    targetFolder = parts.slice(treeIndex + 2).join('/');
                } else if (parts.length > 1 && parts[1] !== 'tree') {
                    targetFolder = parts.slice(1).join('/');
                }
            } else {
                currentRepo = rawRepo;
            }
            
            document.getElementById('repo-title').textContent = currentRepo.toUpperCase();
            document.getElementById('repo-description').textContent = targetFolder ? `/${targetFolder}` : 'Root Directory';
        }

        async function getMdFilesFromRepo(owner, repoName, folderPath) {
            try {
                const branchResponse = await fetch(`https://api.github.com/repos/${owner}/${repoName}`);
                if (!branchResponse.ok) {
                    if (branchResponse.status === 404) throw new Error("Repository not found or Private.");
                    if (branchResponse.status === 403) throw new Error("API rate limit exceeded.");
                    throw new Error(`Status: ${branchResponse.status}`);
                }
                const branchData = await branchResponse.json();
                defaultBranchName = branchData.default_branch;

                const treeResponse = await fetch(`https://api.github.com/repos/${owner}/${repoName}/git/trees/${defaultBranchName}?recursive=1`);
                if (!treeResponse.ok) throw new Error(`Tree fetch failed: ${treeResponse.status}`);
                const treeData = await treeResponse.json();

                return treeData.tree
                    .filter(file => {
                        const pathLower = file.path.toLowerCase();
                        return pathLower.endsWith('.md') && !pathLower.endsWith('readme.md') && file.type === 'blob' && 
                               (folderPath ? file.path.startsWith(folderPath + '/') || file.path === folderPath : true);
                    })
                    .map(file => file.path);
            } catch (error) {
                console.error(`Failed to get files:`, error);
                throw error; 
            }
        }

        function createSidebarItem(filePath, title, folderPath) {
            const fileId = getSafeId(filePath); // Safely encode unicode/emojis
            const item = document.createElement('div');
            item.className = 'group flex items-center gap-3 p-2.5 rounded-xl cursor-pointer transition-all mb-1 text-sm border border-transparent hover:bg-white/5 hover:text-white text-slate-400';
            item.id = `nav-${fileId}`;
            
            item.innerHTML = `
                <svg class="w-4 h-4 opacity-50 shrink-0 group-hover:text-red-400 group-hover:opacity-100 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <span class="truncate font-medium">${title}</span>
            `;
            
            item.addEventListener('click', () => {
                setActiveState(fileId);
                fetchAndShowFile(currentOwner, currentRepo, title, filePath, folderPath);
                
                // On mobile, scroll down to content when clicked
                if (window.innerWidth < 1024) {
                    setTimeout(() => {
                        document.querySelector('section').scrollIntoView({ behavior: 'smooth' });
                    }, 100);
                }
            });
            return item;
        }

        function setActiveState(fileId) {
            // Remove active from all
            document.querySelectorAll('[id^="nav-"]').forEach(el => {
                el.classList.remove('bg-red-500/10', 'text-red-400', 'border-red-500/20');
                el.classList.add('text-slate-400', 'border-transparent', 'hover:bg-white/5', 'hover:text-white');
                el.querySelector('svg').classList.remove('text-red-400', 'opacity-100');
                el.querySelector('svg').classList.add('opacity-50');
            });
            
            // Add to selected
            const activeEl = document.getElementById(`nav-${fileId}`);
            if (activeEl) {
                activeEl.classList.remove('text-slate-400', 'border-transparent', 'hover:bg-white/5', 'hover:text-white');
                activeEl.classList.add('bg-red-500/10', 'text-red-400', 'border-red-500/20');
                activeEl.querySelector('svg').classList.remove('opacity-50');
                activeEl.querySelector('svg').classList.add('text-red-400', 'opacity-100');
            }
        }

        async function fetchAndShowFile(owner, repoName, title, filePath, folderPath) {
            // UI Loading state
            noteViewerTitle.textContent = title;
            currentFolderEl.innerHTML = folderPath === 'root' ? '~ / root' : `~ / ${folderPath.replace(/\//g, ' / ')}`;
            repoLink.classList.remove('hidden');
            repoLink.classList.add('flex');
            repoLink.href = `https://github.com/${owner}/${repoName}/blob/${defaultBranchName}/${filePath}`;
            
            noteViewerContent.classList.remove('fade-in');
            noteViewerContent.innerHTML = `
                <div class="h-64 flex flex-col items-center justify-center">
                    <div class="spinner w-8 h-8 border-2 rounded-full mb-4"></div>
                    <p class="text-sm font-mono text-slate-500">> decrypting markdown...</p>
                </div>`;
            
            // Reset scroll
            scrollContainer.scrollTop = 0;

            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repoName}/contents/${filePath}`);
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                const binaryString = atob(data.content);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
                const markdownContent = new TextDecoder('utf-8').decode(bytes);

                // Reset mathBlocks for the new file rendering
                mathBlocks = [];

                // Render content and trigger animation
                noteViewerContent.innerHTML = showdownConverter.makeHtml(markdownContent);
                noteViewerContent.classList.add('fade-in');

                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise([noteViewerContent]);
                }
            } catch (error) {
                noteViewerContent.innerHTML = `
                    <div class="p-6 bg-red-500/10 border border-red-500/20 rounded-xl text-center mt-10">
                        <p class="text-red-400 font-bold mb-2">Decryption Failed</p>
                        <p class="text-slate-400 text-sm">${error.message}</p>
                    </div>`;
            }
        }

        function findAndOpenNote(noteName, displayTitle) {
            const normalize = str => str.toLowerCase().replace(/[-_ ]/g, '');
            const targetNormalized = normalize(noteName);
            
            let foundPath = null;
            let foundFolder = null;
            for (const filePath of allMdFiles) {
                const fileName = filePath.split('/').pop().replace('.md', '');
                if (normalize(fileName) === targetNormalized) {
                    foundPath = filePath;
                    const parts = filePath.split('/');
                    foundFolder = parts.length > 1 ? parts.slice(0, -1).join('/') : 'root';
                    break;
                }
            }
            if (foundPath) {
                const fileId = getSafeId(foundPath); // Safely encode unicode/emojis
                setActiveState(fileId);
                fetchAndShowFile(currentOwner, currentRepo, displayTitle, foundPath, foundFolder);
            } else {
                alert(`Note not found: "${noteName}"`);
            }
        }

        async function populateSidebar() {
            if (!currentOwner || !currentRepo) {
                sidebarContent.innerHTML = '<p class="text-red-400 text-sm p-4">Error: Repository not specified.</p>';
                return;
            }

            try {
                const mdFiles = await getMdFilesFromRepo(currentOwner, currentRepo, targetFolder);
                allMdFiles = mdFiles;
                
                if (mdFiles.length > 0) {
                    sidebarContent.innerHTML = '';
                    
                    const groupedFiles = mdFiles.reduce((acc, filePath) => {
                        const parts = filePath.split('/');
                        let folder = 'root';
                        if (parts.length > 1) folder = parts.slice(0, -1).join('/');
                        if (!acc[folder]) acc[folder] = [];
                        acc[folder].push(filePath);
                        return acc;
                    }, {});

                    function naturalSort(a, b) {
                        if (a === 'root') return -1;
                        if (b === 'root') return 1;
                        const re = /(\d+)/g;
                        const partsA = a.split(re);
                        const partsB = b.split(re);
                        for (let i = 0; i < Math.min(partsA.length, partsB.length); i++) {
                            if (i % 2 === 1) {
                                const numA = parseInt(partsA[i], 10), numB = parseInt(partsB[i], 10);
                                if (numA !== numB) return numA - numB;
                            } else {
                                if (partsA[i] !== partsB[i]) return partsA[i].localeCompare(partsB[i]);
                            }
                        }
                        return partsA.length - partsB.length;
                    }

                    const sortedFolders = Object.keys(groupedFiles).sort(naturalSort);
                    let firstFileLoaded = false;

                    sortedFolders.forEach(folder => {
                        // Create Folder Heading
                        if (folder !== 'root' || sortedFolders.length > 1) {
                            const folderTitle = document.createElement('h3');
                            folderTitle.className = 'text-[10px] font-bold uppercase tracking-widest text-slate-500 mb-2 mt-6 px-2';
                            let displayFolderName = folder === 'root' ? 'General' : folder.split('/').pop();
                            folderTitle.textContent = displayFolderName.replace(/[-_]/g, ' ');
                            sidebarContent.appendChild(folderTitle);
                        }

                        // Add files under heading
                        groupedFiles[folder].forEach(filePath => {
                            const title = filePath.split('/').pop().replace('.md', '').replace(/[-_]/g, ' ');
                            const item = createSidebarItem(filePath, title, folder);
                            sidebarContent.appendChild(item);
                            
                            // Auto-load first file
                            if (!firstFileLoaded) {
                                firstFileLoaded = true;
                                setTimeout(() => {
                                    item.click(); 
                                }, 100);
                            }
                        });
                    });
                } else {
                    sidebarContent.innerHTML = '<p class="text-slate-500 text-sm p-4">No Markdown files found.</p>';
                }
            } catch (error) {
                sidebarContent.innerHTML = `
                    <div class="p-4 bg-red-500/10 border border-red-500/20 rounded-xl">
                        <p class="text-red-400 font-bold mb-1 text-sm">Failed to load</p>
                        <p class="text-slate-400 text-xs">${error.message}</p>
                    </div>`;
            }
        }

        // Obsidian Link Click Handler
        noteViewerContent.addEventListener('click', (e) => {
            const link = e.target.closest('a.obsidian-link');
            if (link) {
                e.preventDefault();
                findAndOpenNote(link.getAttribute('data-note-name'), link.innerText);
            }
        });
        
        populateSidebar();
    </script>
</body>
</html>