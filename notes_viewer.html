<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aiden Korbs - Notes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" integrity="sha384-KiWOvVjnN8qwKMvhQnlEMWdcGpbMlWbTAESmlOKNLIbBIjTr9iA/B5S8j/ALU5B1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" integrity="sha384-hIoBPJpTUs74ddyc4bB2EaTsf/e/fMoNlnbAViBwA98xKGFEEe/zSBNsXDGMiT2C" crossorigin="anonymous"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown-katex/0.8.0/showdown-katex.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .spinner {
            border-top-color: #f43f5e;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* --- Enhanced Markdown Styling --- */
        #note-viewer-content h1 {
            color: white;
            font-weight: 800; /* extrabold */
            border-bottom: 1px solid #374151;
            padding-bottom: 0.5rem;
            margin-top: 2rem;
            margin-bottom: 1.5rem;
        }
        #note-viewer-content h2 {
            color: white;
            font-weight: 700; /* bold */
            border-bottom: 1px solid #374151; 
            padding-bottom: 0.5rem;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        #note-viewer-content h3 {
            color: white;
            font-weight: 600; /* semibold */
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        #note-viewer-content p { 
            margin-bottom: 1rem; 
            color: #d1d5db; /* text-gray-300 */
            line-height: 1.7; /* Increased line height */
        }
        /* Regular links */
        #note-viewer-content a:not(.obsidian-link) { 
            color: #f43f5e; /* text-rose-500 */
            text-decoration: underline;
            transition: color 0.2s;
        }
        #note-viewer-content a:not(.obsidian-link):hover { 
            color: #fb7185; /* text-rose-400 */
        }
        
        /* Inline code */
        #note-viewer-content code { 
            background-color: #374151; /* bg-gray-700 */
            color: #fca5a5; /* text-red-300 */
            padding: 0.25rem 0.5rem; 
            border-radius: 6px; 
            font-size: 0.9em;
            font-family: monospace;
        }
        /* Code blocks */
        #note-viewer-content pre { 
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
            padding: 1rem; 
            border-radius: 0.5rem; 
            overflow-x: auto; 
            margin-bottom: 1rem;
        }
        #note-viewer-content pre code {
             padding: 0;
             background-color: transparent;
             color: inherit; /* Inherit color from pre */
             font-size: 1em; /* Reset font size */
        }
        #note-viewer-content ul,
        #note-viewer-content ol { 
            padding-left: 2rem; 
            margin-bottom: 1rem; 
            color: #d1d5db;
        }
         #note-viewer-content ul { list-style-type: disc; }
         #note-viewer-content ol { list-style-type: decimal; }
         
        #note-viewer-content li { 
            margin-bottom: 0.5rem; 
            line-height: 1.6;
        }
        /* Blockquotes */
        #note-viewer-content blockquote { 
            border-left: 4px solid #2563eb; /* border-blue-600 */
            background-color: #1f2937; /* bg-gray-800 */
            padding: 1rem 1.5rem; 
            margin: 1.5rem 0; 
            color: #9ca3af; /* text-gray-400 */
            font-style: italic;
        }
        #note-viewer-content blockquote p {
            margin-bottom: 0; /* No extra margin for paragraphs in blockquotes */
        }
        
        /* Tables */
        #note-viewer-content table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-bottom: 1.5rem;
            border: 1px solid #374151; /* border-gray-700 */
        }
        #note-viewer-content th { 
            background-color: #374151; /* bg-gray-700 */
            padding: 0.75rem 1rem; 
            border: 1px solid #4b5563; /* border-gray-600 */
            text-align: left;
            font-weight: 700; /* bold */
            color: white;
        }
        #note-viewer-content td { 
            padding: 0.75rem 1rem; 
            border: 1px solid #374151; /* border-gray-700 */
        }
        #note-viewer-content tr:nth-child(even) { 
            background-color: #1f2937; /* bg-gray-800 */
        }
        
        /* Obsidian-style links */
        #note-viewer-content a.obsidian-link {
            color: #60a5fa; /* text-blue-400 */
            text-decoration: none;
            border-bottom: 1px dashed #60a5fa;
            opacity: 0.8;
            transition: all 0.2s;
        }
        #note-viewer-content a.obsidian-link:hover {
            color: #93c5fd; /* text-blue-300 */
            border-bottom-style: solid;
            opacity: 1;
        }

        /* KaTeX dark theme override */
        .katex {
            color: #d1d5db; /* text-gray-300 */
            font-size: 1.1em;
        }
    </style>
</head>
<body class="text-gray-200 min-h-screen">

    <header class="border-b border-gray-700/50 sticky top-0 bg-gray-900/80 backdrop-blur-sm z-10">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-xl font-bold text-white hover:text-rose-400 transition-colors">Aiden Korbs</a>
            <div class="flex items-center space-x-6">
                <a href="index.html" class="text-gray-400 hover:text-white transition-colors font-medium">Projects</a>
                <a href="notes.html" class="text-white font-medium">Notes</a>
                <a href="about.html" class="text-gray-400 hover:text-white transition-colors font-medium">About</a>
                <a href="https://github.com/Aiden-korbs" target="_blank" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.168 6.839 9.492.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.031-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.378.203 2.398.1 2.651.64.7 1.03 1.595 1.03 2.688 0 3.848-2.338 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.001 10.001 0 0022 12c0-5.523-4.477-10-10-10z" clip-rule="evenodd" /></svg>
                </a>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-12">
        <div class="max-w-4xl mx-auto">
            <h1 id="repo-title" class="text-4xl font-extrabold text-white mb-8"></h1>
            <p id="repo-description" class="text-gray-400 mb-12"></p>
            <div id="notes-grid" class="space-y-12">
                </div>
        </div>
    </main>

    <div id="note-viewer" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-gray-800 border border-gray-700/80 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-700/80">
                <h2 id="note-viewer-title" class="text-xl font-bold text-white"></h2>
                <button id="close-viewer-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div id="note-viewer-content"></div>
            </div>
             <div class="p-4 border-t border-gray-700/80 text-right">
                <a id="repo-link" href="#" target="_blank" class="text-sm font-medium text-rose-500 hover:text-rose-400 transition-colors">View on GitHub &rarr;</a>
            </div>
        </div>
    </div>

    <footer class="mt-12 border-t border-gray-700/50">
        <div class="container mx-auto px-6 py-8 text-center text-gray-400">
            <p>&copy; 2025 Aiden Korbs. All Rights Reserved.</p>
        </div>
    </footer>

    <script>
        // --- SCRIPT LOGIC ---
        const notesGrid = document.getElementById('notes-grid');
        const noteViewer = document.getElementById('note-viewer');
        const noteViewerTitle = document.getElementById('note-viewer-title');
        const noteViewerContent = document.getElementById('note-viewer-content');
        const closeViewerBtn = document.getElementById('close-viewer-btn');
        const repoLink = document.getElementById('repo-link');
        
        let allMdFiles = [];
        let currentOwner = '';
        let currentRepo = '';
        
        // Register KaTeX and Obsidian links extensions
        const showdownConverter = new showdown.Converter({
            tables: true,
            tasklists: true,
            simplifiedAutoLink: true,
            strikethrough: true,
            ghCompatibleHeaderId: true,
            extensions: ['katex', 'obsidianlinks'] // <-- CORRECTED LINE
        });
        
        showdown.extension('obsidianlinks', () => {
            return [{
                type: 'lang',
                regex: /\[\[([^\]]+)\]\]/g,
                replace: (match, noteName) => {
                    return `<a href="#" class="obsidian-link" data-note-name="${noteName}">${noteName}</a>`;
                }
            }];
        });

        const urlParams = new URLSearchParams(window.location.search);
        const owner = urlParams.get('owner');
        const repo = urlParams.get('repo');
        currentOwner = owner;
        currentRepo = repo;
        
        document.getElementById('repo-title').textContent = repo ? `Notes: ${repo}` : 'Notes Viewer';
        document.getElementById('repo-description').textContent = repo ? `Browsing all Markdown notes found in the '${repo}' repository.` : 'Specify a repository in the URL to view its notes.';

        async function getMdFilesFromRepo(owner, repo) {
            try {
                const branchResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}`);
                if (!branchResponse.ok) throw new Error(`Could not fetch repo info. Status: ${branchResponse.status}`);
                const branchData = await branchResponse.json();
                const defaultBranch = branchData.default_branch;

                const treeResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/${defaultBranch}?recursive=1`);
                if (!treeResponse.ok) throw new Error(`Could not fetch repo tree. Status: ${treeResponse.status}`);
                const treeData = await treeResponse.json();
                
                return treeData.tree
                    .filter(file => file.path.endsWith('.md') && 
                                   !file.path.toLowerCase().endsWith('readme.md') && 
                                   file.type === 'blob')
                    .map(file => file.path);
            } catch (error) {
                console.error(`Failed to get files for ${owner}/${repo}:`, error);
                return [];
            }
        }

        function createNoteCard(filePath, owner, repo) {
            const card = document.createElement('div');
            card.className = 'block cursor-pointer bg-gray-800/50 p-6 rounded-lg border border-gray-700/80 hover:border-rose-500/80 transition-all duration-300 transform hover:-translate-y-1';
            
            const title = filePath.split('/').pop().replace('.md', '').replace(/[-_]/g, ' ');
            
            card.innerHTML = `<h3 class="text-xl font-bold text-white capitalize">${title}</h3> <p class="mt-2 text-gray-500 text-xs truncate">File: ${filePath}</p>`;
            card.addEventListener('click', () => fetchAndShowFile(owner, repo, title, filePath));
            return card;
        }

        async function fetchAndShowFile(owner, repo, title, filePath) {
            noteViewerTitle.textContent = title;
            noteViewerContent.innerHTML = '<div class="flex justify-center items-center h-48"><div class="spinner w-8 h-8 border-4 rounded-full"></div></div>';
            repoLink.href = `https://github.com/${owner}/${repo}/blob/main/${filePath}`;
            noteViewer.classList.remove('hidden');
            noteViewer.classList.add('flex');

            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`);
                if (!response.ok) throw new Error(`GitHub API Error: ${response.status}`);
                const data = await response.json();
                
                // Decode Base64 (atob) to a byte string
                const binaryString = atob(data.content);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // Use TextDecoder for proper UTF-8 handling
                const textDecoder = new TextDecoder('utf-8');
                const markdownContent = textDecoder.decode(bytes);
                
                noteViewerContent.innerHTML = showdownConverter.makeHtml(markdownContent);
            } catch (error) {
                console.error("Error fetching file:", error);
                noteViewerContent.innerHTML = `<p class="text-red-400">Could not load notes.</p><p class="text-gray-500 text-xs">${error.message}</p>`;
            }
        }
        
        function findAndOpenNote(noteName) {
            const normalize = (str) => str.toLowerCase().replace(/[-_ ]/g, '');
            const targetNormalized = normalize(noteName);

            let foundPath = null;
            
            for (const filePath of allMdFiles) {
                const fileName = filePath.split('/').pop().replace('.md', '');
                const fileNormalized = normalize(fileName);
                
                if (fileNormalized === targetNormalized) {
                    foundPath = filePath;
                    break;
                }
            }

            if (foundPath) {
                fetchAndShowFile(currentOwner, currentRepo, noteName, foundPath);
            } else {
                alert(`Note not found: "${noteName}"`);
            }
        }
        
        // Natural sort function for folder names
        function naturalSort(a, b) {
            if (a === 'root') return -1;
            if (b === 'root') return 1;
            const re = /(\d+)/g;
            const partsA = a.split(re);
            const partsB = b.split(re);

            for (let i = 0; i < Math.min(partsA.length, partsB.length); i++) {
                const partA = partsA[i];
                const partB = partsB[i];
                if (i % 2 === 1) { // It's a number
                    const numA = parseInt(partA, 10);
                    const numB = parseInt(partB, 10);
                    if (numA !== numB) {
                        return numA - numB;
                    }
                } else { // It's a string
                    if (partA !== partB) {
                        return partA.localeCompare(partB);
                    }
                }
            }
            return partsA.length - partsB.length;
        }


        async function populateNotesPage() {
            if (!owner || !repo) {
                notesGrid.innerHTML = '<p class="text-red-400 text-center">Error: Repository owner and name not specified in the URL. Example: ?owner=yourname&repo=yourrepo</p>';
                document.getElementById('repo-description').textContent = 'Please provide repository details in the URL.';
                return;
            }

            notesGrid.innerHTML = '<div class="flex justify-center items-center h-48"><div class="spinner w-8 h-8 border-4 rounded-full"></div><p class="ml-4">Scanning repository...</p></div>';
            
            const mdFiles = await getMdFilesFromRepo(owner, repo);
            allMdFiles = mdFiles;
            
            if (mdFiles.length > 0) {
                notesGrid.innerHTML = '';
                
                const groupedFiles = mdFiles.reduce((acc, filePath) => {
                    const parts = filePath.split('/');
                    let folder = 'root';
                    if (parts.length > 1) {
                        folder = parts.slice(0, -1).join('/');
                    }
                    if (!acc[folder]) {
                        acc[folder] = [];
                    }
                    acc[folder].push(filePath);
                    return acc;
                }, {});

                const sortedFolders = Object.keys(groupedFiles).sort(naturalSort);

                let commonPrefix = '';
                const nonRootFolders = sortedFolders.filter(f => f !== 'root');

                if (nonRootFolders.length > 0) {
                    const paths = nonRootFolders.map(f => f.split('/'));
                    const minLength = Math.min(...paths.map(p => p.length));
                    let prefixComponents = [];
                    for (let i = 0; i < minLength; i++) {
                        const component = paths[0][i];
                        if (paths.every(p => p[i] === component)) {
                            prefixComponents.push(component);
                        } else {
                            break;
                        }
                    }

                    if (prefixComponents.length > 0) {
                        const tempPrefix = prefixComponents.join('/') + '/';
                        // Check if ALL non-root folders start with this prefix
                        if (nonRootFolders.every(f => f.startsWith(tempPrefix))) {
                             commonPrefix = tempPrefix;
                        }
                    }
                }

                sortedFolders.forEach(folder => {
                    const sectionContainer = document.createElement('div');
                    
                    const folderTitle = document.createElement('h2');
                    folderTitle.className = 'text-3xl font-bold text-white mb-6 border-b border-gray-700/80 pb-3 capitalize';
                    
                    let displayFolderName = folder;
                    if (folder === 'root') {
                        displayFolderName = 'General Notes';
                    } else if (commonPrefix && folder.startsWith(commonPrefix)) {
                        displayFolderName = folder.substring(commonPrefix.length);
                        
                        if (displayFolderName === '') { // Safety check in case folder *is* the common prefix
                            displayFolderName = folder.split('/').pop(); 
                        }
                    }
                    
                    folderTitle.textContent = displayFolderName.replace(/[-_]/g, ' ');

                    sectionContainer.appendChild(folderTitle);

                    const folderGrid = document.createElement('div');
                    folderGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-6';
                    
                    groupedFiles[folder].forEach(filePath => {
                        const card = createNoteCard(filePath, owner, repo);
                        folderGrid.appendChild(card);
                    });

                    sectionContainer.appendChild(folderGrid);
                    notesGrid.appendChild(sectionContainer);
                });

            } else {
                notesGrid.innerHTML = '<p class="text-gray-500 text-center">No Markdown files (excluding READMEs) found in this repository.</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', populateNotesPage);

        closeViewerBtn.addEventListener('click', () => noteViewer.classList.add('hidden'));
        noteViewer.addEventListener('click', (e) => {
            if (e.target === noteViewer) noteViewer.classList.add('hidden');
        });
        
        noteViewerContent.addEventListener('click', (e) => {
            const link = e.target.closest('a.obsidian-link');
            if (link) {
                e.preventDefault();
                const targetNoteName = link.getAttribute('data-note-name');
                findAndOpenNote(targetNoteName);
            }
        });

    </script>
</body>
</html>